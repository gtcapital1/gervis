cd /var/www/gervis && sudo ./deploy/scripts/setup-aws.sh
╔═════════════════════════════════════════════════╗
║                                                 ║
║      CONFIGURAZIONE AUTOMATICA GERVIS          ║
║                                                 ║
╚═════════════════════════════════════════════════╝

Questo script configurerà automaticamente:
  - Nginx con il dominio gervis.it
  - PostgreSQL e il database gervis
  - PM2 per l'avvio automatico dell'applicazione
  - Let's Encrypt per HTTPS (opzionale)

ATTENZIONE: Questo script deve essere eseguito come sudo!

[INFO] Verifica dei requisiti...
[ERROR] Il comando 'nginx' non è installato. Installalo con 'sudo apt-get install nginx'
[ERROR] Il comando 'psql' non è installato. Installalo con 'sudo apt-get install psql'
[ERROR] Il comando 'nodejs' non è installato. Installalo con 'sudo apt-get install nodejs'
[INFO] Mancano 3 comandi necessari. Installazione automatica...
[INFO] Aggiornamento dei repository...
./deploy/scripts/setup-aws.sh: line 94: apt-get: command not found
[INFO] Installazione di Nginx...
./deploy/scripts/setup-aws.sh: line 99: apt-get: command not found
[INFO] Installazione di PostgreSQL...
./deploy/scripts/setup-aws.sh: line 105: apt-get: command not found
[INFO] Installazione di Node.js...
Error: This script is only supported on Debian-based systems.
./deploy/scripts/setup-aws.sh: line 112: apt-get: command not found
[INFO] Installazione di PM2...

changed 134 packages in 4s

13 packages are looking for funding
  run `npm fund` for details
[SUCCESS] Tutti i requisiti sono soddisfatti!
[INFO] Configurazione del database PostgreSQL...
sudo: unknown user postgres
sudo: error initializing audit plugin sudoers_audit
[INFO] Creazione del database 'gervis'...
sudo: unknown user postgres
sudo: error initializing audit plugin sudoers_audit
[INFO] Creazione dell'utente 'gervis'...
sudo: unknown user postgres
sudo: error initializing audit plugin sudoers_audit
[INFO] Assegnazione dei privilegi...
sudo: unknown user postgres
sudo: error initializing audit plugin sudoers_audit
[SUCCESS] Database configurato con successo!
[INFO] Creazione del file .env...
[SUCCESS] File .env creato con successo!
[INFO] Configurazione di Nginx per il dominio gervis.it...
./deploy/scripts/setup-aws.sh: line 174: /etc/nginx/sites-available/gervis: No such file or directory
ln: failed to create symbolic link '/etc/nginx/sites-enabled/': No such file or directory
[INFO] Sito abilitato in Nginx.
./deploy/scripts/setup-aws.sh: line 225: nginx: command not found
[ERROR] Errore nella configurazione di Nginx!
[INFO] Configurazione di PM2...
[SUCCESS] File ecosystem.config.cjs creato con successo!
[INFO] Configurazione di Drizzle...
[SUCCESS] File drizzle.config.json creato con successo!
[INFO] Avvio dell'applicazione con PM2...
[INFO] Build dell'applicazione...

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

sh: line 1: vite: command not found
[PM2] Applying action restartProcessId on app [gervis](ids: [ 0 ])
[PM2] [gervis](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ gervis             │ fork     │ 2    │ online    │ 0%       │ 15.2mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[INFO] Configurazione di PM2 per l'avvio automatico...
[PM2] Init System found: systemd
Platform systemd
Template
[Unit]
Description=PM2 process manager
Documentation=https://pm2.keymetrics.io/
After=network.target

[Service]
Type=forking
User=root
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/var/lib/snapd/snap/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=PM2_HOME=/root/.pm2
PIDFile=/root/.pm2/pm2.pid
Restart=on-failure

ExecStart=/usr/lib/node_modules/pm2/bin/pm2 resurrect
ExecReload=/usr/lib/node_modules/pm2/bin/pm2 reload all
ExecStop=/usr/lib/node_modules/pm2/bin/pm2 kill

[Install]
WantedBy=multi-user.target

Target path
/etc/systemd/system/pm2-root.service
Command list
[ 'systemctl enable pm2-root' ]
[PM2] Writing init configuration in /etc/systemd/system/pm2-root.service
[PM2] Making script booting at startup...
[PM2] [-] Executing: systemctl enable pm2-root...
[PM2] [v] Command successfully executed.
+---------------------------------------+
[PM2] Freeze a process list on reboot via:
$ pm2 save

[PM2] Remove init script via:
$ pm2 unstartup systemd
[PM2] Saving current process list...
[PM2] Successfully saved in /root/.pm2/dump.pm2
[SUCCESS] Applicazione avviata con PM2 e configurata per l'avvio automatico!
[INFO] Configurazione automatica di HTTPS con Let's Encrypt...
[INFO] Installazione di Certbot...
./deploy/scripts/setup-aws.sh: line 306: apt-get: command not found
./deploy/scripts/setup-aws.sh: line 307: apt-get: command not found
[INFO] Richiesta del certificato SSL per gervis.it...
./deploy/scripts/setup-aws.sh: line 312: certbot: command not found
[ERROR] Errore nella configurazione di HTTPS!

╔═════════════════════════════════════════════════╗
║                                                 ║
║         CONFIGURAZIONE COMPLETATA!             ║
║                                                 ║
╚═════════════════════════════════════════════════╝

L'applicazione Gervis è stata configurata con successo!

Dettagli configurazione:
  - Dominio: gervis.it
  - Database: postgresql://gervis:******@localhost:5432/gervis
  - Applicazione in esecuzione con PM2
  - Nginx configurato per il routing
  - HTTPS configurato con Let's Encrypt

Per verificare lo stato dell'applicazione, esegui:
  pm2 status

Per visualizzare i log dell'applicazione:
  pm2 logs gervis

Per accedere all'applicazione, visita:
  https://gervis.it

Grazie per aver scelto Gervis!
[ec2-user@ip-172-31-36-102 gervis]$ 
